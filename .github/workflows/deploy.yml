name: Nest CI/CD

on:
  push:
    branches: [ main ]

jobs:
  build-test-deploy:
    runs-on: self-hosted
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install dependencies
      run: npm install

    - name: Run tests
      run: npm run test

    - name: Build project
      run: npm run build

    # ---------- STAGING ----------
    - name: Deploy to staging
      run: |
        echo "ðŸ”¥ NUCLEAR CLEANUP STARTED"
    
        # Kill ALL mysql_db containers (even stuck ones)
        docker rm -f $(docker ps -aq --filter "name=mysql_db") 2>/dev/null || true
        
        # Kill ALL staging containers
        docker rm -f $(docker ps -aq --filter "name=staging") 2>/dev/null || true
        
        # Full docker-compose cleanup
        cd ~/staging-server || true
        docker compose down --volumes --rmi all --remove-orphans 2>/dev/null || true
        
        # Copy fresh code
        rm -rf ~/staging-server/*
        rsync -av --exclude='.git' . ~/staging-server/
        
        # Build & start
        cd ~/staging-server
        docker compose up -d --build --force-recreate

    - name: Wait for app
      run: sleep 15

    - name: Health Check
      run: curl -f http://localhost:3000

    # ---------- PRODUCTION ----------
    - name: Deploy to production
      run: |
        # âœ… FIX: Copy from staging (already clean)
        rm -rf ~/prod-server/*
        rsync -av ~/staging-server/ ~/prod-server/
        cd ~/prod-server
        docker compose down
        docker compose up -d --build
